# Space Station Power Generation and SARJ Control Demo

## Installation
 - Clone the source
```
$ cd /path/to/ros2_ws
$ mkdir src
$ cd src
$ git clone https://github.com/space-station-os/demo_sarj_power_generation.git
```
 - Compile the source
```
$ cd /path/to/ros2_ws
$ colcon build --symlink-install
$ source install/setup.bash
```

## Run
1. Terminal 1: SARJ angle optimization node
```
$ ros2 run demo_sarj_power_generation select_sarj_angle
```
2. Terminal 2: Dynamics & power generation node
```
$ ros2 run demo_sarj_power_generation power_generation
```
3. Terminal 3: Record
```
$ source rosbag_record.sh
```

## Check Result
Simulation result is recorded as a rosbag file in the directory "rosbag2_out".
You can check it by
```
$ rqt_bag rosbag2_out/rosbag2_YYYY-MM-DD_hh_mm_ss/
```

## Command and published output
```
$ cd space_station_os_dev/src/space_station_power_demo
$ colcon build
$ source install/setup.bash
```
Terminal 1.
```
$ ros2 run demo_sarj_power_generation power_generation
```
Then the ROS node "space_station_power_demo" publishes two messages, generated power [W] and battery level [Wh] (or state of charge, SoC). They can be shown by rqt_plot.
If you plot them, graphs are like this:
![image](https://github.com/user-attachments/assets/6fdb9c3b-9d36-4d80-9cfc-9ae2ba2378f5)

## Simulation Overview
The earth orbit around the Sun and space station orbit and attitude are simulated.
### Orbit Dynamics
The earth rotetes around the Sun. Its orbit is perfect circle.
The space station rotetes around the earth. Its orbit is perfect circle. Orbital elements such as altitde, RAAN and inclination can be set. Initial attitude is set as Euler angle Z->Y->X. And angular velocity is set as roll, pitch, yaw.
### Space Station Attitude
There are two types of space station attitude control. It can be set as a parameter when running.
 - 0: No control
 - 1: LVLH

### Power Generation
Shade of the space station by the earth is simulated.
And SAP angle to the sun is calculated.
If the space station is not in shade by the earth, its SAP can generate power.
Its amount depends on the SAP angle to the sun. The angle between the normal vector of the solar cell and the vector in the sun direction is $$\theta$$. The amount of power generated is proportional to $$\cos(\theta)$$, with a maximum value of max_generated_power when $$\theta=0$$ degrees.

### SARJ
Three axis shows space station body fixed (SSBF) frame.
The space station has Solar Alpha Rotary Joint (SARJ). It can rotate solar array panel (SAP) along Y-axis.  
![image](https://github.com/user-attachments/assets/3dd53072-e600-4cbb-b6cd-cd39f9704b59)
  
SAP generates power by sunlight.  
The amount of electricity generated by the SAP depends on the orientation of the normal vector of the SAP and the vector in the direction of the sun. It is maximum when both are parallel.  
![image](https://github.com/user-attachments/assets/97a998d0-b544-4091-964a-75ea4e88be40)
  
There are two ROS nodes. “power_generation” simulates orbit, attitude, and power generation of the space station. “select_sarj_angle” gets sun direction vector @SSBF, calculates optimal SARJ angle and publish it as “/terget_sarj_angle”. Then “power_generation” subscribes it and set SARJ angle.  
![image](https://github.com/user-attachments/assets/89d358d5-e31b-4a59-a462-93ad8e4ba37a)


## Parameters
Space station parameters:
- ss_altitude: altitude of space station orbit.
- ss_raan: RAAN of space station orbit.
- ss_inclination: inclination of space station orbit.
- ss_init_euler_angle: atitude of space station as Euler angle.
- ss_init_w_vec: angular velocity of space station.

Simulation parameters:
- simu_timestep: timestep of simulation [s]
- speed_rate: rate of simulation

These parameters can be set by like:
```
ros2 run demo_sarj_power_generation demo_sarj_power_generation --ros-args -p simu_timestep:="2.0"
```

## Publish
Three messages are published.
- simulation time [s]
- generated power [W]
- battery level [Wh] (or state of charge, SoC).
You can check them by using rosbag or rqt_plot.

## To-do
- Implementation of SARJ (Solar Alpha Rotary Joint) control. By controling SARJ angle, power generation amount can be optimized.
- Split code. All programs are written in src/demo_sarj_power_generation.cpp now. They should be splitted into different files.
